<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TNA 2026 - Bank Sulselbar</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary: #0A4D8C;
            --primary-dark: #063A6A;
            --primary-light: #1E6FBA;
            --primary-bg: #E8F4FC;
            --secondary: #D4A84B;
            --success: #10B981;
            --success-bg: #D1FAE5;
            --warning: #F59E0B;
            --warning-bg: #FEF3C7;
            --danger: #EF4444;
            --danger-bg: #FEE2E2;
            --purple: #8B5CF6;
            --purple-bg: #EDE9FE;
            --dark: #1A1A2E;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            min-height: 100vh;
            color: var(--gray-700);
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-lg);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .header-left img {
            height: 45px;
            border-radius: 8px;
            background: white;
            padding: 4px;
        }
        
        .header-left h1 {
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .header-left p {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .btn-logout {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .btn-logout:hover {
            background: rgba(255,255,255,0.25);
        }
        
        /* Main Container */
        .main-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Title Section */
        .title-section {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .title-section h2 {
            font-size: 1.75rem;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }
        
        /* Info Box */
        .info-box {
            background: var(--primary-bg);
            border-left: 4px solid var(--primary);
            border-radius: var(--radius);
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
        }
        
        .info-box i {
            color: var(--primary);
            font-size: 1.1rem;
            margin-top: 2px;
        }
        
        .info-box p {
            font-size: 0.9rem;
            color: var(--gray-600);
            line-height: 1.6;
        }
        
        /* Card */
        .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1rem 1.5rem;
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        /* Form */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.2s;
            background: white;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(10, 77, 140, 0.1);
        }
        
        .form-group input:disabled,
        .form-group select:disabled {
            background: var(--gray-100);
            cursor: not-allowed;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-group .display-value {
            padding: 0.75rem 1rem;
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 0.95rem;
            color: var(--gray-700);
            min-height: 44px;
        }
        
        /* Autocomplete */
        .autocomplete-wrapper {
            position: relative;
        }
        
        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--gray-200);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: var(--shadow-lg);
            display: none;
        }
        
        .autocomplete-results.show {
            display: block;
        }
        
        .autocomplete-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-100);
            transition: background 0.15s;
        }
        
        .autocomplete-item:hover {
            background: var(--primary-bg);
        }
        
        .autocomplete-item .name {
            font-weight: 600;
            color: var(--dark);
        }
        
        .autocomplete-item .info {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-top: 2px;
        }
        
        /* Modul Section */
        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .modul-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        @media (max-width: 768px) {
            .modul-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Modul Detail Box */
        .modul-detail-box {
            background: var(--gray-50);
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            display: none;
        }
        
        .modul-detail-box.show {
            display: block;
        }
        
        .modul-detail-box h4 {
            font-size: 1rem;
            color: var(--dark);
            margin-bottom: 0.75rem;
        }
        
        .modul-detail-box ul {
            margin-left: 1.25rem;
            color: var(--gray-600);
            font-size: 0.9rem;
            line-height: 1.8;
        }
        
        /* Button */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        
        .btn-add {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #047857 0%, var(--success) 100%);
            color: white;
            font-size: 1rem;
        }
        
        .btn-add:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Daftar Modul Dipilih */
        .selected-modul-list {
            margin-top: 1rem;
        }
        
        .selected-modul-item {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .selected-modul-item .modul-info {
            flex: 1;
        }
        
        .selected-modul-item .modul-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }
        
        .selected-modul-item .modul-meta {
            font-size: 0.8rem;
            color: var(--gray-500);
        }
        
        .selected-modul-item .modul-alasan {
            font-size: 0.85rem;
            color: var(--gray-600);
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--gray-100);
        }
        
        .btn-remove {
            background: var(--danger-bg);
            color: var(--danger);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .btn-remove:hover {
            background: var(--danger);
            color: white;
        }
        
        /* Pills/Badges */
        .pill {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .pill-primary {
            background: var(--primary-bg);
            color: var(--primary);
        }
        
        .pill-success {
            background: var(--success-bg);
            color: var(--success);
        }
        
        .pill-warning {
            background: var(--warning-bg);
            color: var(--warning);
        }
        
        .pill-purple {
            background: var(--purple-bg);
            color: var(--purple);
        }
        
        /* Summary Card */
        .summary-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-top: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .summary-info h3 {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }
        
        .summary-info p {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            color: white;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .toast-success { background: var(--success); }
        .toast-error { background: var(--danger); }
        .toast-warning { background: var(--warning); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 1rem;
            color: var(--gray-600);
            font-weight: 500;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--gray-500);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Login Page */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }
        
        .login-card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 2.5rem;
            width: 100%;
            max-width: 420px;
            text-align: center;
        }
        
        .login-card img {
            height: 60px;
            margin-bottom: 1.5rem;
        }
        
        .login-card h1 {
            font-size: 1.5rem;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }
        
        .login-card p {
            color: var(--gray-500);
            margin-bottom: 1.5rem;
        }
        
        .login-card .form-group {
            text-align: left;
        }
        
        .login-card .btn {
            width: 100%;
            justify-content: center;
            padding: 1rem;
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p class="loading-text">Memuat data...</p>
    </div>

    <!-- Login Page -->
    <div class="login-page" id="loginPage">
        <div class="login-card">
            <img src="./logo.png" alt="Bank Sulselbar">
            <h1>Training Needs Analysis</h1>
            <p>Silakan masuk dengan NPP Anda untuk melanjutkan</p>
            
            <form id="loginForm">
                <div class="form-group">
                    <label>Nomor Pokok Pegawai (NPP)</label>
                    <input type="text" id="loginNPP" placeholder="Contoh: 8005538" required>
                    <small style="color: var(--gray-500); font-size: 0.8rem;">Format NPP lengkap (7-8 digit)</small>
                </div>
                <div id="loginAlert" style="margin-bottom: 1rem;"></div>
                <button type="submit" class="btn btn-primary" id="btnLogin">
                    <i class="fas fa-sign-in-alt"></i> Masuk
                </button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-page hidden" id="appPage">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <img src="./logo.png" alt="Bank Sulselbar">
                <div>
                    <h1>TNA 2026</h1>
                    <p>Training Needs Analysis</p>
                </div>
            </div>
            <button class="btn-logout" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Keluar
            </button>
        </header>

        <!-- Main Content -->
        <div class="main-container">
            <!-- Title -->
            <div class="title-section">
                <h2>Training Needs Analysis (TNA) 2026</h2>
            </div>

            <!-- Info Box -->
            <div class="info-box">
                <i class="fas fa-info-circle"></i>
                <p>TNA merupakan metode validasi untuk memetakan kebutuhan pendidikan Anda. Pastikan pengisian dilakukan dengan saksama dan telah dikoordinasikan dengan pimpinan Anda. Hasil TNA selanjutnya akan dievaluasi secara kolektif oleh divisi terkait sebagai dasar penentuan prioritas pelatihan.</p>
            </div>

            <!-- Data Pegawai Card -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-user"></i> Data Pegawai
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group autocomplete-wrapper">
                            <label>Cari Nama Pegawai</label>
                            <input type="text" id="searchNama" placeholder="Ketik nama Anda..." autocomplete="off">
                            <div class="autocomplete-results" id="autocompleteResults"></div>
                        </div>
                        <div class="form-group">
                            <label>NPP</label>
                            <div class="display-value" id="displayNPP">-</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Jabatan</label>
                            <div class="display-value" id="displayJabatan">-</div>
                        </div>
                        <div class="form-group">
                            <label>Unit Kerja</label>
                            <div class="display-value" id="displayUnit">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pilih Modul Card -->
            <div class="card" id="modulCard" style="display: none;">
                <div class="card-header">
                    <i class="fas fa-book"></i> Pilih Modul & Detail Pelaksanaan
                </div>
                <div class="card-body">
                    <!-- Modul Selection -->
                    <div class="modul-grid">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Modul Kompetensi</label>
                            <select id="selectModul">
                                <option value="">-- Pilih Modul --</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Jenis Kategori</label>
                            <select id="selectKategori">
                                <option value="Pelatihan">1. Pelatihan</option>
                                <option value="Sertifikasi">2. Sertifikasi</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Rekomendasi Pelaksanaan</label>
                            <select id="selectRekomendasi">
                                <option value="Internal">Internal</option>
                                <option value="Eksternal">Eksternal</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Bulan Pelaksanaan</label>
                            <select id="selectBulan">
                                <option value="Januari">Januari</option>
                                <option value="Februari">Februari</option>
                                <option value="Maret">Maret</option>
                                <option value="April">April</option>
                                <option value="Mei">Mei</option>
                                <option value="Juni">Juni</option>
                                <option value="Juli">Juli</option>
                                <option value="Agustus">Agustus</option>
                                <option value="September">September</option>
                                <option value="Oktober">Oktober</option>
                                <option value="November">November</option>
                                <option value="Desember">Desember</option>
                            </select>
                        </div>
                    </div>

                    <!-- Modul Detail Box -->
                    <div class="modul-detail-box" id="modulDetailBox">
                        <h4 id="modulDetailTitle">Nama Modul</h4>
                        <ul id="modulDetailList"></ul>
                    </div>

                    <!-- Alasan -->
                    <div class="form-group">
                        <label>Alasan Memilih Modul Ini</label>
                        <textarea id="inputAlasan" placeholder="Jelaskan kondisi spesifik mengapa Anda membutuhkan pelatihan ini..."></textarea>
                    </div>

                    <!-- Referensi -->
                    <div class="form-group">
                        <label>Referensi Judul Pelatihan</label>
                        <textarea id="inputReferensi" placeholder="Jika tidak ada, isi 'tidak ada'."></textarea>
                    </div>

                    <!-- Add Button -->
                    <button class="btn btn-add" id="btnTambahModul" onclick="tambahModul()">
                        <i class="fas fa-plus-circle"></i> Tambah Modul ke Daftar
                    </button>
                </div>
            </div>

            <!-- Daftar Modul Dipilih -->
            <div class="card" id="daftarCard" style="display: none;">
                <div class="card-header">
                    <i class="fas fa-list-check"></i> Daftar Modul Dipilih
                </div>
                <div class="card-body">
                    <div class="selected-modul-list" id="selectedModulList">
                        <div class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <p>Belum ada modul yang dipilih</p>
                        </div>
                    </div>

                    <!-- Summary & Submit -->
                    <div class="summary-card" id="summaryCard" style="display: none;">
                        <div class="summary-info">
                            <h3><span id="totalModul">0</span> Modul Dipilih</h3>
                            <p>Siap untuk disubmit</p>
                        </div>
                        <button class="btn btn-success" onclick="submitTNA()">
                            <i class="fas fa-paper-plane"></i> Submit TNA
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBiwuLzJ8lVBsP9UJ4w6HU2JevCF7K8NNk",
            authDomain: "tnahumancapital.firebaseapp.com",
            projectId: "tnahumancapital",
            storageBucket: "tnahumancapital.firebasestorage.app",
            messagingSenderId: "618822378444",
            appId: "1:618822378444:web:8cd59870928bd251613369"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global State
        let allPegawai = [];
        let allModul = [];
        let allJabatan = [];
        let currentUser = null;
        let currentJabatan = null;
        let availableModul = [];
        let selectedModulList = [];

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', async function() {
            await loadInitialData();
            hideLoading();
        });

        async function loadInitialData() {
            try {
                // Load all pegawai
                const pegawaiSnap = await db.collection('pegawai').get();
                pegawaiSnap.forEach(doc => {
                    allPegawai.push({ id: doc.id, ...doc.data() });
                });
                console.log('Loaded pegawai:', allPegawai.length);

                // Load all modul
                const modulSnap = await db.collection('modul').get();
                modulSnap.forEach(doc => {
                    allModul.push({ id: doc.id, ...doc.data() });
                });
                console.log('Loaded modul:', allModul.length);

                // Load all jabatan
                const jabatanSnap = await db.collection('jabatan').get();
                jabatanSnap.forEach(doc => {
                    allJabatan.push({ id: doc.id, ...doc.data() });
                });
                console.log('Loaded jabatan:', allJabatan.length);

            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Gagal memuat data. Silakan refresh halaman.', 'error');
            }
        }

        // ===== LOGIN =====
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const npp = document.getElementById('loginNPP').value.trim();
            
            if (!npp) {
                showLoginAlert('NPP tidak boleh kosong');
                return;
            }

            const pegawai = allPegawai.find(p => p.npp === npp || p.id === npp);
            
            if (!pegawai) {
                showLoginAlert('NPP tidak ditemukan. Pastikan format NPP benar (7-8 digit).');
                return;
            }

            currentUser = pegawai;
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('appPage').classList.remove('hidden');
            
            // Pre-fill data
            document.getElementById('searchNama').value = pegawai.nama;
            selectPegawai(pegawai);
        });

        function showLoginAlert(msg) {
            document.getElementById('loginAlert').innerHTML = `
                <div style="background: var(--danger-bg); color: var(--danger); padding: 0.75rem; border-radius: 8px; font-size: 0.9rem;">
                    <i class="fas fa-exclamation-circle"></i> ${msg}
                </div>
            `;
        }

        function logout() {
            currentUser = null;
            currentJabatan = null;
            availableModul = [];
            selectedModulList = [];
            
            document.getElementById('appPage').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('loginNPP').value = '';
            document.getElementById('loginAlert').innerHTML = '';
            document.getElementById('searchNama').value = '';
            document.getElementById('displayNPP').textContent = '-';
            document.getElementById('displayJabatan').textContent = '-';
            document.getElementById('displayUnit').textContent = '-';
            document.getElementById('modulCard').style.display = 'none';
            document.getElementById('daftarCard').style.display = 'none';
        }

        // ===== AUTOCOMPLETE =====
        document.getElementById('searchNama').addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            const results = document.getElementById('autocompleteResults');
            
            if (query.length < 2) {
                results.classList.remove('show');
                return;
            }

            const matches = allPegawai.filter(p => 
                p.nama && p.nama.toLowerCase().includes(query)
            ).slice(0, 10);

            if (matches.length === 0) {
                results.innerHTML = '<div class="autocomplete-item"><span class="name">Tidak ditemukan</span></div>';
            } else {
                results.innerHTML = matches.map(p => `
                    <div class="autocomplete-item" onclick="selectPegawaiFromSearch('${p.npp}')">
                        <div class="name">${p.nama}</div>
                        <div class="info">NPP: ${p.npp} | ${p.jabatan || '-'}</div>
                    </div>
                `).join('');
            }
            
            results.classList.add('show');
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.autocomplete-wrapper')) {
                document.getElementById('autocompleteResults').classList.remove('show');
            }
        });

        function selectPegawaiFromSearch(npp) {
            const pegawai = allPegawai.find(p => p.npp === npp);
            if (pegawai) {
                currentUser = pegawai;
                document.getElementById('searchNama').value = pegawai.nama;
                document.getElementById('autocompleteResults').classList.remove('show');
                selectPegawai(pegawai);
            }
        }

        function selectPegawai(pegawai) {
            document.getElementById('displayNPP').textContent = pegawai.npp;
            document.getElementById('displayJabatan').textContent = pegawai.jabatan || '-';
            document.getElementById('displayUnit').textContent = pegawai.unit_kerja || '-';

            // Find jabatan and load modul
            loadJabatanModul(pegawai.jabatan);
        }

        // ===== LOAD JABATAN MODUL =====
        function loadJabatanModul(jabatanName) {
            if (!jabatanName) {
                showToast('Jabatan tidak ditemukan', 'warning');
                return;
            }

            // Find matching jabatan
            currentJabatan = allJabatan.find(j => 
                j.nama_jabatan && j.nama_jabatan.toLowerCase() === jabatanName.toLowerCase()
            );

            if (!currentJabatan) {
                // Try partial match
                currentJabatan = allJabatan.find(j => 
                    j.nama_jabatan && (
                        j.nama_jabatan.toLowerCase().includes(jabatanName.toLowerCase()) ||
                        jabatanName.toLowerCase().includes(j.nama_jabatan.toLowerCase())
                    )
                );
            }

            if (!currentJabatan) {
                console.log('Jabatan not found:', jabatanName);
                showToast('Jabatan tidak ditemukan dalam matrix TNA', 'warning');
                document.getElementById('modulCard').style.display = 'block';
                document.getElementById('daftarCard').style.display = 'block';
                
                // Show all modul as options
                availableModul = allModul.map(m => ({
                    ...m,
                    status: 'opsional'
                }));
                populateModulSelect();
                return;
            }

            // Collect available modul from jabatan
            availableModul = [];
            
            // Soft skill modul - wajib
            (currentJabatan.modul_soft_wajib || []).forEach(code => {
                const modul = allModul.find(m => m.kode === code || m.id === code);
                if (modul) availableModul.push({ ...modul, status: 'wajib', jenis: 'soft' });
            });
            
            // Soft skill modul - opsional
            (currentJabatan.modul_soft_opsional || []).forEach(code => {
                const modul = allModul.find(m => m.kode === code || m.id === code);
                if (modul) availableModul.push({ ...modul, status: 'opsional', jenis: 'soft' });
            });
            
            // Tech skill modul - wajib
            (currentJabatan.modul_tech_wajib || []).forEach(code => {
                const modul = allModul.find(m => m.kode === code || m.id === code);
                if (modul) availableModul.push({ ...modul, status: 'wajib', jenis: 'technical' });
            });
            
            // Tech skill modul - opsional
            (currentJabatan.modul_tech_opsional || []).forEach(code => {
                const modul = allModul.find(m => m.kode === code || m.id === code);
                if (modul) availableModul.push({ ...modul, status: 'opsional', jenis: 'technical' });
            });

            console.log('Available modul:', availableModul.length);

            // Show cards
            document.getElementById('modulCard').style.display = 'block';
            document.getElementById('daftarCard').style.display = 'block';

            // Populate select
            populateModulSelect();
            
            // Load previous submission
            loadPreviousSubmission();
        }

        function populateModulSelect() {
            const select = document.getElementById('selectModul');
            
            // Group by jenis and status
            const softWajib = availableModul.filter(m => m.jenis === 'soft' && m.status === 'wajib');
            const softOpsional = availableModul.filter(m => m.jenis === 'soft' && m.status === 'opsional');
            const techWajib = availableModul.filter(m => m.jenis === 'technical' && m.status === 'wajib');
            const techOpsional = availableModul.filter(m => m.jenis === 'technical' && m.status === 'opsional');

            let html = '<option value="">-- Pilih Modul --</option>';

            if (softWajib.length > 0) {
                html += '<optgroup label="ðŸ”µ Soft Skill - Wajib">';
                softWajib.forEach(m => {
                    html += `<option value="${m.kode}">${m.kode} - ${m.nama}</option>`;
                });
                html += '</optgroup>';
            }

            if (softOpsional.length > 0) {
                html += '<optgroup label="ðŸ”· Soft Skill - Opsional">';
                softOpsional.forEach(m => {
                    html += `<option value="${m.kode}">${m.kode} - ${m.nama}</option>`;
                });
                html += '</optgroup>';
            }

            if (techWajib.length > 0) {
                html += '<optgroup label="ðŸŸ¢ Technical - Wajib">';
                techWajib.forEach(m => {
                    html += `<option value="${m.kode}">${m.kode} - ${m.nama}</option>`;
                });
                html += '</optgroup>';
            }

            if (techOpsional.length > 0) {
                html += '<optgroup label="ðŸŸ© Technical - Opsional">';
                techOpsional.forEach(m => {
                    html += `<option value="${m.kode}">${m.kode} - ${m.nama}</option>`;
                });
                html += '</optgroup>';
            }

            select.innerHTML = html;
        }

        // ===== MODUL DETAIL =====
        document.getElementById('selectModul').addEventListener('change', function() {
            const kode = this.value;
            const detailBox = document.getElementById('modulDetailBox');
            
            if (!kode) {
                detailBox.classList.remove('show');
                return;
            }

            const modul = availableModul.find(m => m.kode === kode) || allModul.find(m => m.kode === kode);
            
            if (modul) {
                document.getElementById('modulDetailTitle').textContent = modul.nama;
                
                // Parse tujuan into list
                const tujuan = modul.tujuan || '';
                const tujuanList = tujuan.split(/\d+\.\s*/).filter(t => t.trim());
                
                if (tujuanList.length > 0) {
                    document.getElementById('modulDetailList').innerHTML = tujuanList.map(t => `<li>${t.trim()}</li>`).join('');
                } else {
                    document.getElementById('modulDetailList').innerHTML = `<li>${tujuan || 'Tidak ada deskripsi'}</li>`;
                }
                
                detailBox.classList.add('show');
            }
        });

        // ===== TAMBAH MODUL =====
        function tambahModul() {
            const kode = document.getElementById('selectModul').value;
            const kategori = document.getElementById('selectKategori').value;
            const rekomendasi = document.getElementById('selectRekomendasi').value;
            const bulan = document.getElementById('selectBulan').value;
            const alasan = document.getElementById('inputAlasan').value.trim();
            const referensi = document.getElementById('inputReferensi').value.trim();

            if (!kode) {
                showToast('Pilih modul terlebih dahulu', 'warning');
                return;
            }

            if (!alasan) {
                showToast('Alasan tidak boleh kosong', 'warning');
                return;
            }

            // Check if already added
            if (selectedModulList.find(m => m.kode === kode)) {
                showToast('Modul ini sudah ditambahkan', 'warning');
                return;
            }

            const modul = availableModul.find(m => m.kode === kode) || allModul.find(m => m.kode === kode);

            selectedModulList.push({
                kode: kode,
                nama: modul?.nama || kode,
                kategori: kategori,
                rekomendasi: rekomendasi,
                bulan: bulan,
                alasan: alasan,
                referensi: referensi || 'tidak ada',
                status: modul?.status || 'opsional',
                jenis: modul?.jenis || 'technical'
            });

            renderSelectedModul();
            
            // Reset form
            document.getElementById('selectModul').value = '';
            document.getElementById('inputAlasan').value = '';
            document.getElementById('inputReferensi').value = '';
            document.getElementById('modulDetailBox').classList.remove('show');

            showToast('Modul berhasil ditambahkan', 'success');
        }

        function renderSelectedModul() {
            const container = document.getElementById('selectedModulList');
            const summaryCard = document.getElementById('summaryCard');

            if (selectedModulList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>Belum ada modul yang dipilih</p>
                    </div>
                `;
                summaryCard.style.display = 'none';
                return;
            }

            container.innerHTML = selectedModulList.map((m, idx) => `
                <div class="selected-modul-item">
                    <div class="modul-info">
                        <div class="modul-name">
                            ${m.nama}
                            <span class="pill ${m.status === 'wajib' ? 'pill-primary' : 'pill-success'}">${m.status}</span>
                            <span class="pill pill-purple">${m.jenis}</span>
                        </div>
                        <div class="modul-meta">
                            ${m.kategori} â€¢ ${m.rekomendasi} â€¢ ${m.bulan}
                        </div>
                        <div class="modul-alasan">
                            <strong>Alasan:</strong> ${m.alasan}
                            ${m.referensi !== 'tidak ada' ? `<br><strong>Referensi:</strong> ${m.referensi}` : ''}
                        </div>
                    </div>
                    <button class="btn-remove" onclick="hapusModul(${idx})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');

            document.getElementById('totalModul').textContent = selectedModulList.length;
            summaryCard.style.display = 'flex';
        }

        function hapusModul(idx) {
            selectedModulList.splice(idx, 1);
            renderSelectedModul();
            showToast('Modul dihapus', 'success');
        }

        // ===== SUBMIT TNA =====
        async function submitTNA() {
            if (selectedModulList.length === 0) {
                showToast('Tambahkan minimal 1 modul', 'warning');
                return;
            }

            if (!currentUser) {
                showToast('Data pegawai tidak valid', 'error');
                return;
            }

            showLoading();

            try {
                const submission = {
                    npp: currentUser.npp,
                    nama: currentUser.nama,
                    jabatan: currentUser.jabatan,
                    unit_kerja: currentUser.unit_kerja,
                    modul: selectedModulList,
                    tahun: 2026,
                    submitted_at: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'submitted'
                };

                const docId = `${currentUser.npp}_2026`;
                await db.collection('submissions').doc(docId).set(submission, { merge: true });

                hideLoading();
                showToast('TNA berhasil disubmit!', 'success');

            } catch (error) {
                console.error('Submit error:', error);
                hideLoading();
                showToast('Gagal submit TNA. Silakan coba lagi.', 'error');
            }
        }

        // ===== LOAD PREVIOUS SUBMISSION =====
        async function loadPreviousSubmission() {
            if (!currentUser) return;

            try {
                const docId = `${currentUser.npp}_2026`;
                const doc = await db.collection('submissions').doc(docId).get();

                if (doc.exists) {
                    const data = doc.data();
                    if (data.modul && Array.isArray(data.modul)) {
                        selectedModulList = data.modul;
                        renderSelectedModul();
                        showToast('Data TNA sebelumnya berhasil dimuat', 'success');
                    }
                }
            } catch (error) {
                console.error('Load submission error:', error);
            }
        }

        // ===== UTILITIES =====
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'exclamation-circle'}"></i>
                ${message}
            `;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
